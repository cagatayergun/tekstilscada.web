@page "/raporlar"

@using TekstilScada.Models
@using TekstilScada.Repositories
@using TekstilScada.WebApp.Services
@inject ScadaDataService ScadaDataService

<PageTitle>Raporlar</PageTitle>

<h1>Üretim Raporları</h1>

<div class="card">
    <div class="card-header">Filtreler</div>
    <div class="card-body">
        <div class="row g-3 align-items-end">
            <div class="col-md-3">
                <label>Başlangıç Tarihi:</label>
                <InputDate @bind-Value="filters.StartTime" class="form-control" />
            </div>
            <div class="col-md-3">
                <label>Bitiş Tarihi:</label>
                <InputDate @bind-Value="filters.EndTime" class="form-control" />
            </div>
            <div class="col-md-4">
                <label>Makine:</label>
                <select class="form-select" @bind="selectedMachineId">
                    <option value="0">TÜM MAKİNELER</option>
                    @if (machines != null)
                    {
                        foreach (var machine in machines)
                        {
                            <option value="@machine.Id">@machine.MachineName</option>
                        }
                    }
                </select>
            </div>
            <div class="col-md-2">
                <button class="btn btn-primary w-100" @onclick="GenerateReport" disabled="@isLoading">
                    @if (isLoading)
                    {
                        <span class="spinner-border spinner-border-sm"></span>
                    }
                    else
                    {

                        <span>Raporla</span>
                    }
                </button>
            </div>
        </div>
    </div>
</div>

@if (isLoading)
{
    <p class="mt-3"><em>Rapor oluşturuluyor...</em></p>
}
else if (reportItems != null)
{
    <h4 class="mt-4">Rapor Sonuçları (@reportItems.Count kayıt bulundu)</h4>
    <div class="table-responsive">
        <table class="table table-striped table-hover mt-2">
            <thead>
                <tr>
                    <th>Makine Adı</th>
                    <th>Reçete Adı</th>
                    <th>Batch No</th>
                    <th>Başlangıç</th>
                    <th>Bitiş</th>
                    <th>Süre</th>
                </tr>
            </thead>
            <tbody>
                @foreach (var item in reportItems)
                {
                    <tr>
                        <td>@item.MachineName</td>
                        <td>@item.RecipeName</td>
                        <td>@item.BatchId</td>
                        <td>@item.StartTime.ToString("dd.MM.yyyy HH:mm")</td>
                        <td>@item.EndTime.ToString("dd.MM.yyyy HH:mm")</td>
                        <td>@item.CycleTime</td>
                    </tr>
                }
            </tbody>
        </table>
    </div>
}

@code {
    private ReportFilters filters = new();
    private List<Machine>? machines;
    private List<ProductionReportItem>? reportItems;
    private bool isLoading = false;
    private int selectedMachineId = 0;

    protected override async Task OnInitializedAsync()
    {
        filters.StartTime = DateTime.Now.AddDays(-7);
        filters.EndTime = DateTime.Now;
        machines = await ScadaDataService.GetMachinesAsync();
    }

    private async Task GenerateReport()
    {
        isLoading = true;
        reportItems = null;

        // Filtrede seçilen makine ID'sini nullable int'e çeviriyoruz
        filters.MachineId = selectedMachineId == 0 ? null : selectedMachineId;

        reportItems = await ScadaDataService.GetProductionReportAsync(filters);
        isLoading = false;
    }
}